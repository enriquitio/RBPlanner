<!DOCTYPE html>
<html>
<head>
    <title>Azure Maps Route Viewer</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>
    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" type="text/css" />
    <style>
        html, body, #myMap {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="myMap"></div>

    <script>
        const subscriptionKey = '9FLh3kPCfweiSL1PanMH8ytd5EJz57Trvp9Efn0TNDl0wur3WPR1JQQJ99BGACYeBjFyD5jZAAAgAZMP3SKW';

        function getParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                startLat: parseFloat(urlParams.get("startLat")),
                startLon: parseFloat(urlParams.get("startLon")),
                endLat: parseFloat(urlParams.get("endLat")),
                endLon: parseFloat(urlParams.get("endLon"))
            };
        }

        const { startLat, startLon, endLat, endLon } = getParams();

        const map = new atlas.Map('myMap', {
            center: [startLon, startLat],
            zoom: 10,
            authOptions: {
                authType: 'subscriptionKey',
                subscriptionKey
            }
        });

        map.events.add('ready', () => {
            const datasource = new atlas.source.DataSource();
            map.sources.add(datasource);

            // Add pins
            const pins = [
                { name: "Start", coords: [startLon, startLat] },
                { name: "End", coords: [endLon, endLat] }
            ];
            pins.forEach(pin => {
                datasource.add(new atlas.data.Feature(new atlas.data.Point(pin.coords), {
                    title: pin.name
                }));
            });

            map.layers.add(new atlas.layer.SymbolLayer(datasource, null, {
                iconOptions: { image: 'pin-round-blue', allowOverlap: true },
                textOptions: { textField: ['get', 'title'], offset: [0, 1.2], color: 'black' }
            }));

            // Request directions
            const routeUrl = `https://atlas.microsoft.com/route/directions/json?api-version=1.0&subscription-key=${subscriptionKey}&query=${startLat},${startLon}:${endLat},${endLon}&travelMode=car`;

            fetch(routeUrl)
                .then(res => res.json())
                .then(data => {
                    const routeCoords = data.routes[0].legs.flatMap(leg =>
                        leg.points.map(p => [p.longitude, p.latitude])
                    );
                    datasource.add(new atlas.data.Feature(new atlas.data.LineString(routeCoords)));
                    map.layers.add(new atlas.layer.LineLayer(datasource, null, {
                        strokeColor: 'blue',
                        strokeWidth: 4
                    }));
                });
        });
    </script>
</body>
</html>
